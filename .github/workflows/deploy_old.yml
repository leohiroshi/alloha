name: Deploy Alloha Bot to Azure Container Apps

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout repository
      uses: actions/checkout@v4

    - name: üîê Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: üöÄ Deploy with inline application
      run: |
        # Create deployment script
        cat > deploy_script.sh << 'EOF'
        #!/bin/bash
        cd /tmp
        
        # Install dependencies
        pip install fastapi uvicorn httpx aiohttp asyncpg requests python-multipart python-dotenv
        
        # Create application
        cat > app.py << 'PYTHON_APP'
        from fastapi import FastAPI, Request, HTTPException
        from fastapi.responses import PlainTextResponse
        from fastapi.middleware.cors import CORSMiddleware
        import os
        import logging
        import httpx
        import json

        logging.basicConfig(level=logging.INFO)
        logger = logging.getLogger(__name__)

        app = FastAPI(
            title="Alloha WhatsApp Bot",
            description="AI-powered real estate WhatsApp bot", 
            version="1.0.0"
        )

        app.add_middleware(
            CORSMiddleware,
            allow_origins=["*"],
            allow_credentials=True,
            allow_methods=["*"],
            allow_headers=["*"],
        )

        VERIFY_TOKEN = os.getenv("WHATSAPP_WEBHOOK_VERIFY_TOKEN", "alloha_secret")
        ACCESS_TOKEN = os.getenv("WHATSAPP_ACCESS_TOKEN", "")
        PHONE_NUMBER_ID = os.getenv("WHATSAPP_PHONE_NUMBER_ID", "")

        @app.get("/")
        async def root():
            return {
                "message": "ÔøΩ Alloha WhatsApp Bot funcionando!",
                "service": "alloha-bot",
                "version": "1.0.0",
                "status": "‚úÖ Operacional",
                "endpoints": ["/webhook", "/health", "/docs", "/test"],
                "webhook_ready": True
            }

        @app.get("/health")
        async def health():
            return {
                "status": "healthy", 
                "service": "alloha-bot",
                "verify_token_configured": bool(VERIFY_TOKEN),
                "access_token_configured": bool(ACCESS_TOKEN),
                "phone_number_configured": bool(PHONE_NUMBER_ID),
                "webhook_endpoint": "/webhook"
            }

        @app.get("/webhook", response_class=PlainTextResponse)
        async def verify_webhook(request: Request):
            params = request.query_params
            logger.info(f"üîç Webhook verification: {dict(params)}")
            
            mode = params.get("hub.mode")
            token = params.get("hub.verify_token") 
            challenge = params.get("hub.challenge")
            
            logger.info(f"Mode: {mode}, Token: {token}, Challenge: {challenge}")
            
            if not mode or not token or not challenge:
                logger.error("‚ùå Missing parameters")
                raise HTTPException(status_code=400, detail="Missing parameters")
            
            if mode == "subscribe" and token == VERIFY_TOKEN:
                logger.info(f"‚úÖ Webhook verified! Challenge: {challenge}")
                return challenge
            else:
                logger.error(f"‚ùå Verification failed. Expected: {VERIFY_TOKEN}")
                raise HTTPException(status_code=403, detail="Verification failed")

        @app.post("/webhook")
        async def webhook_handler(request: Request):
            try:
                body = await request.json()
                logger.info(f"üì© Webhook received: {body}")
                
                if "entry" in body:
                    for entry in body["entry"]:
                        if "changes" in entry:
                            for change in entry["changes"]:
                                if "value" in change and "messages" in change["value"]:
                                    await process_message(change["value"])
                
                return {"status": "success", "processed": True}
            
            except Exception as e:
                logger.error(f"‚ùå Error: {str(e)}")
                raise HTTPException(status_code=500, detail=str(e))

        async def process_message(value):
            try:
                messages = value.get("messages", [])
                if not messages:
                    return
                
                message = messages[0]
                from_number = message["from"]
                text = message.get("text", {}).get("body", "")
                
                logger.info(f"üì± Message from {from_number}: {text}")
                
                response = await generate_response(text)
                await send_message(from_number, response)
                
            except Exception as e:
                logger.error(f"‚ùå Process error: {str(e)}")

        async def generate_response(message: str) -> str:
            message_lower = message.lower()
            
            if any(word in message_lower for word in ["oi", "ol√°", "hello", "hi"]):
                return "üè† Ol√°! Sou o assistente da Alloha! Como posso ajud√°-lo a encontrar o im√≥vel perfeito?"
            elif any(word in message_lower for word in ["apartamento", "casa", "im√≥vel"]):
                return "üîç √ìtimo! Vamos encontrar o im√≥vel ideal. Qual tipo voc√™ procura e em que regi√£o?"
            elif any(word in message_lower for word in ["pre√ßo", "valor"]):
                return "üí∞ Temos op√ß√µes para todos os or√ßamentos! Qual sua faixa de pre√ßo?"
            else:
                return f"ü§ñ Recebi: '{message}'. Como posso ajudar com im√≥veis hoje?"

        async def send_message(to: str, text: str):
            try:
                if not ACCESS_TOKEN or not PHONE_NUMBER_ID:
                    logger.warning("‚ö†Ô∏è WhatsApp not configured")
                    return
                
                url = f"https://graph.facebook.com/v18.0/{PHONE_NUMBER_ID}/messages"
                headers = {
                    "Authorization": f"Bearer {ACCESS_TOKEN}",
                    "Content-Type": "application/json"
                }
                
                payload = {
                    "messaging_product": "whatsapp",
                    "to": to,
                    "type": "text", 
                    "text": {"body": text}
                }
                
                async with httpx.AsyncClient() as client:
                    resp = await client.post(url, headers=headers, json=payload)
                    if resp.status_code == 200:
                        logger.info(f"‚úÖ Message sent to {to}")
                    else:
                        logger.error(f"‚ùå Send error: {resp.status_code}")
                        
            except Exception as e:
                logger.error(f"‚ùå Send error: {str(e)}")

        @app.get("/test")
        async def test():
            return {
                "status": "‚úÖ OK",
                "verify_token": VERIFY_TOKEN,
                "webhook_url": "https://alloha.app/webhook"
            }
        PYTHON_APP
        
        # Start application
        uvicorn app:app --host 0.0.0.0 --port 8000
        EOF
        
        # Update container app with inline script
        az containerapp update \
          --name alloha-backend \
          --resource-group rg-alloha-prod \
          --image python:3.11-slim \
          --command "/bin/bash" \
          --args "-c" "$(cat deploy_script.sh)" \
          --set-env-vars \
            WHATSAPP_WEBHOOK_VERIFY_TOKEN="${{ secrets.WHATSAPP_WEBHOOK_VERIFY_TOKEN }}" \
            WHATSAPP_ACCESS_TOKEN="${{ secrets.WHATSAPP_ACCESS_TOKEN }}" \
            WHATSAPP_PHONE_NUMBER_ID="${{ secrets.WHATSAPP_PHONE_NUMBER_ID }}" \
            ABACUS_API_KEY="${{ secrets.ABACUS_API_KEY }}" \
            DATABASE_URL="${{ secrets.DATABASE_URL }}" \
            SECRET_KEY="${{ secrets.SECRET_KEY }}" \
            AI_PROVIDER="abacus" \
            ENVIRONMENT="production"

    - name: ‚úÖ Deployment Status
      run: |
        echo "üéâ Deployment completed!"
        echo "üåê Application URL: https://alloha.app"
        echo "üìö API Docs: https://alloha.app/docs"
