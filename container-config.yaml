name: alloha-backend
resourceGroup: rg-alloha-prod
type: Microsoft.App/containerApps
location: East US
properties:
  configuration:
    ingress:
      external: true
      targetPort: 8000
      customDomains:
        - name: alloha.app
          bindingType: SniEnabled
          certificateId: /subscriptions/adfaeed5-81e6-47e5-ac7d-b818fbc412ab/resourceGroups/rg-alloha-prod/providers/Microsoft.App/managedEnvironments/env-alloha-prod/managedCertificates/mc-env-alloha-pro-alloha-app-7095
  template:
    containers:
      - name: alloha-backend
        image: python:3.11-slim
        command: 
          - /bin/bash
          - -c
        args:
          - |
            cd /tmp &&
            pip install fastapi uvicorn aiohttp asyncpg requests python-multipart python-dotenv &&
            cat > main.py << 'EOF'
            from fastapi import FastAPI, Request, HTTPException
            from fastapi.responses import PlainTextResponse
            from fastapi.middleware.cors import CORSMiddleware
            import os
            import logging
            import aiohttp
            import json

            logging.basicConfig(level=logging.INFO)
            logger = logging.getLogger(__name__)

            app = FastAPI(
                title="Alloha WhatsApp Bot",
                description="AI-powered real estate WhatsApp bot",
                version="1.0.0"
            )

            app.add_middleware(
                CORSMiddleware,
                allow_origins=["*"],
                allow_credentials=True,
                allow_methods=["*"],
                allow_headers=["*"],
            )

            VERIFY_TOKEN = os.getenv("WHATSAPP_WEBHOOK_VERIFY_TOKEN", "alloha_secret")
            ACCESS_TOKEN = os.getenv("WHATSAPP_ACCESS_TOKEN", "")
            PHONE_NUMBER_ID = os.getenv("WHATSAPP_PHONE_NUMBER_ID", "")

            @app.get("/")
            async def root():
                return {
                    "message": "Alloha WhatsApp Bot is running!",
                    "service": "alloha-bot",
                    "version": "1.0.0",
                    "endpoints": ["/webhook", "/health", "/docs"],
                    "status": "active"
                }

            @app.get("/health")
            async def health():
                return {
                    "status": "healthy", 
                    "service": "alloha-bot",
                    "verify_token_configured": bool(VERIFY_TOKEN),
                    "access_token_configured": bool(ACCESS_TOKEN),
                    "phone_number_configured": bool(PHONE_NUMBER_ID)
                }

            @app.get("/webhook", response_class=PlainTextResponse)
            async def verify_webhook(request: Request):
                params = request.query_params
                logger.info(f"Webhook verification: {dict(params)}")
                
                mode = params.get("hub.mode")
                token = params.get("hub.verify_token")
                challenge = params.get("hub.challenge")
                
                logger.info(f"Mode: {mode}, Token: {token}, Challenge: {challenge}")
                
                if not mode or not token or not challenge:
                    logger.error("Missing required parameters")
                    raise HTTPException(status_code=400, detail="Missing required parameters")
                
                if mode == "subscribe" and token == VERIFY_TOKEN:
                    logger.info(f"Webhook verified successfully: {challenge}")
                    return challenge
                else:
                    logger.error(f"Verification failed. Expected: {VERIFY_TOKEN}, Got: {token}")
                    raise HTTPException(status_code=403, detail="Verification failed")

            @app.post("/webhook")
            async def webhook_handler(request: Request):
                try:
                    body = await request.json()
                    logger.info(f"Received webhook: {body}")
                    
                    if "messages" in body.get("entry", [{}])[0].get("changes", [{}])[0].get("value", {}):
                        await process_message(body)
                    
                    return {"status": "success"}
                
                except Exception as e:
                    logger.error(f"Error processing webhook: {str(e)}")
                    raise HTTPException(status_code=500, detail=str(e))

            async def process_message(webhook_data):
                try:
                    entry = webhook_data.get("entry", [])[0]
                    changes = entry.get("changes", [])[0]
                    value = changes.get("value", {})
                    
                    if "messages" not in value:
                        return
                    
                    message = value["messages"][0]
                    from_number = message["from"]
                    message_text = message.get("text", {}).get("body", "")
                    
                    logger.info(f"Message from {from_number}: {message_text}")
                    
                    # Resposta simples por enquanto
                    response = f"OlÃ¡! Recebi sua mensagem: '{message_text}'. Em breve implementaremos a IA!"
                    
                    await send_whatsapp_message(from_number, response)
                    
                except Exception as e:
                    logger.error(f"Error processing message: {str(e)}")

            async def send_whatsapp_message(to: str, message: str):
                try:
                    if not ACCESS_TOKEN or not PHONE_NUMBER_ID:
                        logger.warning("WhatsApp not configured")
                        return
                    
                    url = f"https://graph.facebook.com/v18.0/{PHONE_NUMBER_ID}/messages"
                    headers = {
                        "Authorization": f"Bearer {ACCESS_TOKEN}",
                        "Content-Type": "application/json"
                    }
                    
                    payload = {
                        "messaging_product": "whatsapp",
                        "to": to,
                        "type": "text",
                        "text": {"body": message}
                    }
                    
                    async with aiohttp.ClientSession() as session:
                        async with session.post(url, headers=headers, json=payload) as response:
                            if response.status == 200:
                                logger.info(f"Message sent to {to}")
                            else:
                                error_text = await response.text()
                                logger.error(f"Failed to send message: {response.status} - {error_text}")
                                
                except Exception as e:
                    logger.error(f"Error sending message: {str(e)}")

            @app.get("/test")
            async def test():
                return {
                    "test": "ok",
                    "verify_token": VERIFY_TOKEN,
                    "access_token_length": len(ACCESS_TOKEN) if ACCESS_TOKEN else 0,
                    "phone_number_id": PHONE_NUMBER_ID
                }
            EOF
            uvicorn main:app --host 0.0.0.0 --port 8000
        env:
          - name: WHATSAPP_WEBHOOK_VERIFY_TOKEN
            value: alloha_secret
          - name: WHATSAPP_ACCESS_TOKEN
            value: EAFdIh8H8IZCYBPTqT4WKympE61SasAjJbEpML6JEVXJzjI1ZBouO94HRTzhc7k6MRzekjD8VpFFMRIWGlOMCtqsxb6X317N4wMAPgKfqLyLZBu3Asc3p6lsbQ0zbVT0npHGBQ3c9fFJI73VdKEom96KomBXoJZAM2szJJZCup03gTh1T4eERmSKPaUp6oegBdmrBhvJW7SYob2TU7oN4RG1UZA7d0CPt7y1Djdv3sCKrsiqlaRQPp1OhFOzYv0qQZDZD
          - name: WHATSAPP_PHONE_NUMBER_ID
            value: "711526708720131"
          - name: ABACUS_API_KEY
            value: s2_2f0da84aa9574ff2a8eac1f8d5bf7423
